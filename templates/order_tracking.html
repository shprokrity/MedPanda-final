{% extends "base.html" %}
{% block content %}
<div class="order-container">
    <div class="order-header">
        <h2>Order Tracking</h2>
        <div class="order-actions">
            {% if order.status in ['Pending', 'Processing'] %}
            <form action="{{ url_for('cancel_order', order_id=order._id) }}" method="POST" 
                  onsubmit="return confirm('Are you sure you want to cancel this order?');">
                <button type="submit" class="btn btn-danger">
                    <i class="fas fa-times"></i> Cancel Order
                </button>
            </form>
            {% endif %}
            <a href="{{ url_for('orders_list') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Orders
            </a>
        </div>
    </div>

    <div class="order-details">
        <div class="order-info">
            <div class="info-card">
                <h3>Order Information</h3>
                <div class="info-grid">
                    <div class="info-item">
                        <span class="label">Order ID:</span>
                        <span class="value">{{ order._id }}</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Order Date:</span>
                        <span class="value">{{ order.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Status:</span>
                        <span class="status-badge status-{{ order.status|lower|replace(' ', '-') }}">
                            {{ order.status }}
                        </span>
                        {% if order.status == 'Delivered' and order.pharmacy_id %}
                            <div class="mt-2">
                                <a href="{{ url_for('reviews', pharmacy_id=order.pharmacy_id, order_id=order._id) }}" class="btn btn-primary btn-sm">
                                    <i class="fas fa-star"></i> Write a Review
                                </a>
                            </div>
                        {% endif %}
                    </div>
                    <div class="info-item">
                        <span class="label">Subtotal:</span>
                        <span class="value">৳{{ "%.2f"|format(order.total) }}</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Delivery Fee:</span>
                        <span class="value">৳50.00</span>
                    </div>
                    <div class="info-item grand-total">
                        <span class="label">Total Amount:</span>
                        <span class="value">৳{{ "%.2f"|format(order.total + 50) }}</span>
                    </div>
                </div>
            </div>

            <div class="info-card">
                <h3>Delivery Information</h3>
                <div class="info-grid">
                    <div class="info-item">
                        <span class="label">Delivery Address:</span>
                        <span class="value">{{ order.address }}</span>
                    </div>
                    {% if order.assigned_delivery_id %}
                    <div class="info-item">
                        <span class="label">Delivery Partner:</span>
                        <span class="value">Picked Already</span>
                    </div>
                    {% else %}
                        {% if session.user.role == 'pharmacy' %}
                        <div class="info-item">
                            <form action="{{ url_for('request_delivery', order_id=order._id) }}" method="POST" onsubmit="return confirm('Assign delivery to all available delivery men?');">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-truck"></i> Assign Delivery
                                </button>
                            </form>
                        </div>
                        {% endif %}
                    {% endif %}
                </div>
            </div>

            {% if session.user.role in ['pharmacy', 'delivery'] %}
            <div class="info-card">
                <h3>Customer Information</h3>
                <div class="info-grid">
                    <div class="info-item">
                        <span class="label">Customer Name:</span>
                        <span class="value">{{ order.customer_name }}</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Phone Number:</span>
                        <span class="value">{{ order.phone_number }}</span>
                    </div>
                    {% if order.notes %}
                    <div class="info-item">
                        <span class="label">Order Notes:</span>
                        <span class="value">{{ order.notes }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>

        <div class="order-items">
            {% set items = order.items if order.items is defined and order.items is sequence else order.order_items if order.order_items is defined and order.order_items is sequence else [] %}
            <h3>Order Items ({{ items|length }})</h3>
            <div class="items-list">
                {% if items|length > 0 %}
                    {% for item in items %}
                    <div class="order-item">
                        <div class="item-image">
                            <i class="fas fa-pills"></i>
                        </div>
                        <div class="item-details">
                            <h4>{{ item.name }}</h4>
                            <p class="item-category">{{ item.category if item.category else 'General' }}</p>
                            <p class="item-price">৳{{ "%.2f"|format(item.unit_price) }} × {{ item.qty }}</p>
                            <p class="item-total">৳{{ "%.2f"|format(item.line_total) }}</p>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="no-items">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>No items found in this order.</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Order Status Timeline -->
        <div class="status-timeline">
            <h3>Order Status</h3>
            <div class="timeline">
                <div class="timeline-item {% if order.status != 'Cancelled' %}completed{% endif %}">
                    <div class="timeline-marker"></div>
                    <div class="timeline-content">
                        <h4>Order Placed</h4>
                        <p>Your order has been received</p>
                        <span class="timeline-time">{{ order.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                    </div>
                </div>

                <div class="timeline-item {% if order.status in ['Processing', 'Out for Delivery', 'Delivered'] %}completed{% endif %}">
                    <div class="timeline-marker"></div>
                    <div class="timeline-content">
                        <h4>Processing</h4>
                        <p>Order is being prepared</p>
                        {% if order.status in ['Processing', 'Out for Delivery', 'Delivered'] %}
                        <span class="timeline-time">Processing started</span>
                        {% endif %}
                    </div>
                </div>

                <div class="timeline-item {% if order.status in ['Out for Delivery', 'Delivered'] %}completed{% endif %}">
                    <div class="timeline-marker"></div>
                    <div class="timeline-content">
                        <h4>Out for Delivery</h4>
                        <p>Your order is on the way</p>
                        {% if order.status in ['Out for Delivery', 'Delivered'] %}
                        <span class="timeline-time">On the way</span>
                        {% endif %}
                    </div>
                </div>

                <div class="timeline-item {% if order.status in ['Awaiting Confirmation', 'Delivered'] %}completed{% endif %}">
                    <div class="timeline-marker"></div>
                    <div class="timeline-content">
                        <h4>Delivered</h4>
                        <p>{% if order.status == 'Awaiting Confirmation' %}
                            Delivery person has marked this order as delivered. Please confirm receipt.
                            {% elif order.status == 'Delivered' %}
                            Order has been delivered and confirmed
                            {% else %}
                            Waiting for delivery
                            {% endif %}
                        </p>
                        {% if order.status == 'Awaiting Confirmation' and user.role == 'user' %}
                        <form action="{{ url_for('confirm_delivery', order_id=order._id) }}" method="POST"
                              class="confirm-delivery-form">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-check"></i> Confirm Receipt
                            </button>
                        </form>
                        {% endif %}
                        {% if order.status == 'Delivered' %}
                        <span class="timeline-time">Confirmed at {{ order.confirmed_at.strftime('%Y-%m-%d %H:%M') }}</span>
                        {% elif order.status == 'Awaiting Confirmation' %}
                        <span class="timeline-time">Marked delivered at {{ order.delivered_at.strftime('%Y-%m-%d %H:%M') }}</span>
                        {% endif %}
                    </div>
                </div>

                {% if order.status == 'Cancelled' %}
                <div class="timeline-item cancelled">
                    <div class="timeline-marker"></div>
                    <div class="timeline-content">
                        <h4>Cancelled</h4>
                        <p>Order has been cancelled</p>
                        <span class="timeline-time">Cancelled</span>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
.order-container {
    background: white;
    border-radius: 15px;
    padding: 2rem;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    margin: 1rem 0;
    max-width: 1200px;
    margin-left: auto;
    margin-right: auto;
}

.order-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    flex-wrap: wrap;
    gap: 1rem;
}

.order-header h2 {
    color: #2d3748;
    margin: 0;
}

.order-actions {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

.btn {
    padding: 0.8rem 1.5rem;
    border: none;
    border-radius: 6px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

.btn-danger {
    background: #f56565;
    color: white;
}

.btn-danger:hover {
    background: #e53e3e;
    transform: translateY(-1px);
}

.btn-secondary {
    background: #718096;
    color: white;
}

.btn-secondary:hover {
    background: #4a5568;
    transform: translateY(-1px);
}

.order-details {
    display: grid;
    grid-template-columns: 1fr;
    gap: 2rem;
}

.info-card {
    background: #f8fafc;
    padding: 1.5rem;
    border-radius: 10px;
    border: 1px solid #e2e8f0;
}

.info-card h3 {
    margin-bottom: 1rem;
    color: #2d3748;
    border-bottom: 2px solid #e2e8f0;
    padding-bottom: 0.5rem;
}

.info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
}

.info-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0;
    border-bottom: 1px solid #e2e8f0;
}

.info-item:last-child {
    border-bottom: none;
}

.label {
    font-weight: 600;
    color: #4a5568;
}

.value {
    color: #2d3748;
}

.grand-total {
    font-weight: bold;
    font-size: 1.1rem;
    color: #2d3748;
    margin-top: 0.5rem;
    padding-top: 1rem;
    border-top: 2px solid #e2e8f0;
}

.status-badge {
    padding: 0.3rem 0.8rem;
    border-radius: 15px;
    font-size: 0.9rem;
    font-weight: 600;
}

.status-pending {
    background: #fed7d7;
    color: #c53030;
}

.status-processing {
    background: #feebcb;
    color: #d69e2e;
}

.status-out-for-delivery {
    background: #bee3f8;
    color: #3182ce;
}

.status-delivered {
    background: #c6f6d5;
    color: #38a169;
}

.status-cancelled {
    background: #e2e8f0;
    color: #4a5568;
}

.order-items {
    background: #f8fafc;
    padding: 1.5rem;
    border-radius: 10px;
    border: 1px solid #e2e8f0;
}

.order-items h3 {
    margin-bottom: 1rem;
    color: #2d3748;
    border-bottom: 2px solid #e2e8f0;
    padding-bottom: 0.5rem;
}

.items-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.order-item {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 1rem;
    align-items: center;
    padding: 1rem;
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
}

.item-image {
    font-size: 2rem;
    color: #667eea;
}

.item-details h4 {
    color: #2d3748;
    margin-bottom: 0.3rem;
    font-size: 1rem;
}

.item-category {
    color: #718096;
    font-size: 0.8rem;
    background: #edf2f7;
    padding: 0.2rem 0.5rem;
    border-radius: 10px;
    display: inline-block;
    margin-bottom: 0.3rem;
}

.item-price {
    color: #718096;
    font-size: 0.9rem;
    margin-bottom: 0.3rem;
}

.item-total {
    color: #48bb78;
    font-weight: 600;
    font-size: 1rem;
}

.no-items {
    text-align: center;
    padding: 2rem;
    color: #718096;
}

.no-items i {
    font-size: 2rem;
    margin-bottom: 1rem;
    color: #cbd5e0;
}

.no-items p {
    margin: 0;
    font-size: 1.1rem;
}

/* Status Timeline */
.status-timeline {
    background: #f8fafc;
    padding: 1.5rem;
    border-radius: 10px;
    border: 1px solid #e2e8f0;
}

.status-timeline h3 {
    margin-bottom: 1rem;
    color: #2d3748;
    border-bottom: 2px solid #e2e8f0;
    padding-bottom: 0.5rem;
}

.timeline {
    position: relative;
    padding-left: 2rem;
}

.timeline::before {
    content: '';
    position: absolute;
    left: 0.6rem;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #e2e8f0;
}

.timeline-item {
    position: relative;
    margin-bottom: 2rem;
    padding-left: 1rem;
}

.timeline-item:last-child {
    margin-bottom: 0;
}

.timeline-marker {
    position: absolute;
    left: -2rem;
    top: 0.5rem;
    width: 1.2rem;
    height: 1.2rem;
    border-radius: 50%;
    background: #e2e8f0;
    border: 3px solid white;
}

.timeline-item.completed .timeline-marker {
    background: #48bb78;
}

.timeline-item.cancelled .timeline-marker {
    background: #f56565;
}

.timeline-content h4 {
    color: #2d3748;
    margin-bottom: 0.3rem;
    font-size: 1rem;
}

.timeline-content p {
    color: #718096;
    margin-bottom: 0.3rem;
    font-size: 0.9rem;
}

.timeline-time {
    color: #a0aec0;
    font-size: 0.8rem;
    font-style: italic;
}

/* Responsive Design */
@media (max-width: 768px) {
    .order-container {
        padding: 1rem;
    }
    
    .order-header {
        flex-direction: column;
        align-items: stretch;
    }
    
    .order-actions {
        justify-content: center;
    }
    
    .info-grid {
        grid-template-columns: 1fr;
    }
    
    .info-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.3rem;
    }
    
    .order-item {
        grid-template-columns: 1fr;
        text-align: center;
    }
    
    .timeline {
        padding-left: 1.5rem;
    }
    
    .timeline::before {
        left: 0.3rem;
    }
    
    .timeline-marker {
        left: -1.5rem;
    }
}
</style>
{% endblock %}